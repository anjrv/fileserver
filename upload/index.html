<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Files</title>
  <link href="css/styles.css" type="text/css" rel="stylesheet" />
</head>

<body>
  <div id="drop-area">
    <div id="form-container">
      <form class="my-form">
        <input type="file" id="fileElem" multiple accept="image/*" onchange="handleFiles(this.files)" />
        <label class="button" for="fileElem">Lisa fail</label>
      </form>
      <progress id="progress-bar" max="100" value="0"></progress>
    </div>
  </div>
  <script>
    let dropArea = document.getElementById('drop-area');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
      dropArea.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach((eventName) => {
      dropArea.addEventListener(eventName, highlight, false);
    });
    ['dragleave', 'drop'].forEach((eventName) => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false);

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function highlight(e) {
      dropArea.classList.add('highlight');
    }

    function unhighlight(e) {
      dropArea.classList.remove('active');
    }

    function handleDrop(e) {
      var dt = e.dataTransfer;
      var files = dt.files;

      handleFiles(files);
    }

    let uploadProgress = [];
    let progressBar = document.getElementById('progress-bar');

    function initializeProgress(numFiles) {
      progressBar.value = 0;
      uploadProgress = [];

      for (let i = numFiles; i > 0; i--) {
        uploadProgress.push(0);
      }
    }

    function updateProgress(fileNumber, percent) {
      uploadProgress[fileNumber] = percent;
      let total =
        uploadProgress.reduce((tot, curr) => tot + curr, 0) /
        uploadProgress.length;
      progressBar.value = total;
    }

    function handleFiles(files) {
      files = [...files];
      initializeProgress(files.length);
      files.forEach(uploadFile);
    }

    function uploadFile(file, i) {
      console.log(file);
      const url = 'https://192.168.1.1:3002/upload';
      const xhr = new XMLHttpRequest();
      const formData = new FormData();

      xhr.open('POST', url, true);

      xhr.upload.addEventListener('progress', function (e) {
        updateProgress(i, (e.loaded * 100.0) / e.total || 100);
      });

      xhr.addEventListener('readystatechange', function (e) {
        if (xhr.readyState == 4 && xhr.status == 200) {
          // Done. Inform the user
        } else if (xhr.readyState == 4 && xhr.status != 200) {
          // Error. Inform the user
        }
      });

      formData.append('file', file);
      xhr.send(formData);
    }
  </script>
</body>

</html>
